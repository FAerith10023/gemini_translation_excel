<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel 翻译工具 - Web 版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .drop-zone:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .drop-zone.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        .file-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .progress-container {
            display: none;
        }
        .result-container {
            display: none;
        }
        .preview-table {
            font-size: 12px;
            max-width: 100%;
            overflow-x: auto;
        }
        .custom-prompt-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .api-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog"></i> 配置设置</h5>
                    </div>
                    <div class="card-body">
                        <!-- API状态测试 -->
                        <div class="mb-3">
                            <button id="testApiBtn" class="btn btn-outline-primary btn-sm w-100">
                                <i class="fas fa-wifi"></i> 测试API连接
                            </button>
                        </div>
                        
                        <!-- 翻译设置 -->
                        <div class="mb-3">
                            <label class="form-label">源语言</label>
                            <select id="sourceLang" class="form-select">
                                <option value="中文" selected>中文</option>
                                <option value="英文">英文</option>
                                <option value="日文">日文</option>
                                <option value="韩文">韩文</option>
                                <option value="法文">法文</option>
                                <option value="德文">德文</option>
                                <option value="西班牙文">西班牙文</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">目标语言</label>
                            <select id="targetLang" class="form-select">
                                <option value="英文" selected>英文</option>
                                <option value="中文">中文</option>
                                <option value="日文">日文</option>
                                <option value="韩文">韩文</option>
                                <option value="法文">法文</option>
                                <option value="德文">德文</option>
                                <option value="西班牙文">西班牙文</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">翻译区域</label>
                            <input type="text" id="translateRange" class="form-control" 
                                   placeholder="例如: A1:D20" value="A1:Z100">
                            <small class="text-muted">支持格式: A1:D20 或 A1</small>
                        </div>
                    </div>
                </div>
                
                <!-- 自定义提示词 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-magic"></i> 自定义提示词</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <textarea id="customPrompt" class="form-control" rows="4" 
                                      placeholder="输入特殊翻译要求...&#10;例如：&#10;- 量词"个"翻译为"nos"&#10;- 保持技术术语的准确性&#10;- 使用正式的商务用语"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">或上传提示词文件</label>
                            <input type="file" id="promptFile" class="form-control" accept=".txt">
                            <small class="text-muted">支持.txt文件</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 主内容区 -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-language"></i> Excel 翻译工具</h4>
                        <p class="mb-0 text-muted">使用 Google Gemini-2.0-flash API 进行高质量翻译</p>
                    </div>
                    <div class="card-body">
                        <!-- 文件上传区域 -->
                        <div class="step-section">
                            <h5><i class="fas fa-upload"></i> 步骤 1: 上传 Excel 文件</h5>
                            <div class="drop-zone" id="dropZone">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <p class="mb-2">拖拽文件到此处或点击选择文件</p>
                                <p class="text-muted small">支持 .xlsx 和 .xls 格式，最大 16MB</p>
                                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                            </div>
                        </div>
                        
                        <!-- 文件信息显示 -->
                        <div id="fileInfo" class="file-info" style="display: none;">
                            <h6><i class="fas fa-file-excel"></i> 文件信息</h6>
                            <div id="fileDetails"></div>
                        </div>
                        
                        <!-- 文件预览 -->
                        <div id="filePreview" style="display: none;">
                            <h6><i class="fas fa-eye"></i> 文件预览 (前5行)</h6>
                            <div class="table-responsive">
                                <table id="previewTable" class="table table-sm table-bordered preview-table">
                                </table>
                            </div>
                        </div>
                        
                        <!-- 翻译按钮 -->
                        <div id="translateSection" style="display: none;">
                            <hr>
                            <h5><i class="fas fa-language"></i> 步骤 2: 开始翻译</h5>
                            <button id="startTranslate" class="btn btn-primary btn-lg">
                                <i class="fas fa-play"></i> 开始翻译
                            </button>
                        </div>
                        
                        <!-- 进度显示 -->
                        <div id="progressContainer" class="progress-container">
                            <hr>
                            <h5><i class="fas fa-spinner fa-spin"></i> 翻译进行中...</h5>
                            <div class="progress mb-3">
                                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <div id="progressText" class="text-muted"></div>
                        </div>
                        
                        <!-- 结果显示 -->
                        <div id="resultContainer" class="result-container">
                            <hr>
                            <h5><i class="fas fa-check-circle text-success"></i> 翻译完成</h5>
                            <div id="resultDetails" class="alert alert-success"></div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                                <button id="downloadBtn" class="btn btn-success btn-lg">
                                    <i class="fas fa-download"></i> 下载翻译结果
                                </button>
                                <button id="newTranslation" class="btn btn-outline-primary">
                                    <i class="fas fa-plus"></i> 新的翻译
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- API状态提示 -->
    <div id="apiStatus" class="api-status"></div>
    
    <!-- Toast 容器 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFileId = null;
        let downloadUrl = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
        });
        
        function initializeEventListeners() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const testApiBtn = document.getElementById('testApiBtn');
            const startTranslate = document.getElementById('startTranslate');
            const downloadBtn = document.getElementById('downloadBtn');
            const newTranslation = document.getElementById('newTranslation');
            const promptFile = document.getElementById('promptFile');
            
            // 文件拖拽
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            
            // 提示词文件
            promptFile.addEventListener('change', handlePromptFileSelect);
            
            // 按钮事件
            testApiBtn.addEventListener('click', testApiConnection);
            startTranslate.addEventListener('click', startTranslation);
            downloadBtn.addEventListener('click', downloadResult);
            newTranslation.addEventListener('click', resetInterface);
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                uploadFile(file);
            }
        }
        
        function handlePromptFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('customPrompt').value = e.target.result;
                    showToast('提示词文件已加载', 'success');
                };
                reader.readAsText(file, 'utf-8');
            }
        }
        
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            showProgress('上传文件中...');
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideProgress();
                if (data.success) {
                    currentFileId = data.file_id;
                    displayFileInfo(data);
                    showToast('文件上传成功！', 'success');
                } else {
                    showToast(data.error, 'error');
                }
            })
            .catch(error => {
                hideProgress();
                showToast('上传失败: ' + error.message, 'error');
            });
        }
        
        function displayFileInfo(data) {
            const fileInfo = document.getElementById('fileInfo');
            const fileDetails = document.getElementById('fileDetails');
            const filePreview = document.getElementById('filePreview');
            const translateSection = document.getElementById('translateSection');
            
            fileDetails.innerHTML = `
                <p><strong>文件名:</strong> ${data.filename}</p>
                <p><strong>行数:</strong> ${data.max_row} | <strong>列数:</strong> ${data.max_col}</p>
                <p><strong>文件ID:</strong> <code>${data.file_id}</code></p>
            `;
            
            // 显示预览表格
            const previewTable = document.getElementById('previewTable');
            let tableHtml = '';
            
            data.preview.forEach((row, rowIndex) => {
                const rowHtml = row.map(cell => `<td>${cell || ''}</td>`).join('');
                tableHtml += `<tr>${rowHtml}</tr>`;
            });
            
            previewTable.innerHTML = tableHtml;
            
            fileInfo.style.display = 'block';
            filePreview.style.display = 'block';
            translateSection.style.display = 'block';
        }
        
        function testApiConnection() {
            const btn = document.getElementById('testApiBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
            btn.disabled = true;
            
            fetch('/test_api')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('API连接正常！', 'success');
                    updateApiStatus('success', 'API连接正常');
                } else {
                    showToast('API连接失败: ' + data.error, 'error');
                    updateApiStatus('error', 'API连接失败');
                }
            })
            .catch(error => {
                showToast('API测试失败: ' + error.message, 'error');
                updateApiStatus('error', '网络错误');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
        
        function startTranslation() {
            if (!currentFileId) {
                showToast('请先上传文件', 'error');
                return;
            }
            
            const translateData = {
                file_id: currentFileId,
                range: document.getElementById('translateRange').value,
                source_lang: document.getElementById('sourceLang').value,
                target_lang: document.getElementById('targetLang').value,
                custom_prompt: document.getElementById('customPrompt').value
            };
            
            showProgress('开始翻译...');
            document.getElementById('translateSection').style.display = 'none';
            
            fetch('/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(translateData)
            })
            .then(response => response.json())
            .then(data => {
                hideProgress();
                if (data.success) {
                    downloadUrl = data.download_url;
                    displayResult(data);
                    showToast('翻译完成！', 'success');
                } else {
                    showToast(data.error, 'error');
                    document.getElementById('translateSection').style.display = 'block';
                }
            })
            .catch(error => {
                hideProgress();
                showToast('翻译失败: ' + error.message, 'error');
                document.getElementById('translateSection').style.display = 'block';
            });
        }
        
        function displayResult(data) {
            const resultDetails = document.getElementById('resultDetails');
            resultDetails.innerHTML = `
                <h6>翻译统计</h6>
                <p><strong>成功翻译:</strong> ${data.translated_count} 个单元格</p>
                <p><strong>总计发现:</strong> ${data.total_count} 个单元格</p>
                <p><strong>成功率:</strong> ${((data.translated_count / data.total_count) * 100).toFixed(1)}%</p>
                <p><strong>输出文件:</strong> ${data.output_file}</p>
            `;
            
            document.getElementById('resultContainer').style.display = 'block';
        }
        
        function downloadResult() {
            if (downloadUrl) {
                window.location.href = downloadUrl;
            }
        }
        
        function resetInterface() {
            currentFileId = null;
            downloadUrl = null;
            
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('translateSection').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('fileInput').value = '';
            
            showToast('界面已重置，可以上传新文件', 'info');
        }
        
        function showProgress(text) {
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressContainer').style.display = 'block';
        }
        
        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }
        
        function updateApiStatus(status, message) {
            const apiStatus = document.getElementById('apiStatus');
            const className = status === 'success' ? 'alert-success' : 'alert-danger';
            apiStatus.innerHTML = `
                <div class="alert ${className} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${status === 'success' ? 'check' : 'times'}"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastBody = toast.querySelector('.toast-body');
            const toastHeader = toast.querySelector('.toast-header strong');
            
            const types = {
                'success': { icon: 'check', class: 'text-success', title: '成功' },
                'error': { icon: 'times', class: 'text-danger', title: '错误' },
                'info': { icon: 'info', class: 'text-info', title: '提示' }
            };
            
            const config = types[type] || types['info'];
            toastHeader.innerHTML = `<i class="fas fa-${config.icon} ${config.class}"></i> ${config.title}`;
            toastBody.textContent = message;
            
            new bootstrap.Toast(toast).show();
        }
    </script>
</body>
</html> 